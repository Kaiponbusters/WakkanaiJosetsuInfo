# CLAUDE.md

このファイルは、このリポジトリでコードを操作する際にClaude Code (claude.ai/code) へのガイダンスを提供します。

## プロジェクト概要

これは「わっかない除雪情報マップ」(Wakkanai Snow Removal Information Map) - 北海道稚内市のリアルタイム除雪追跡Webアプリケーションです。このアプリは、インタラクティブマップ上で除雪作業を表示し、管理機能を提供します。

## 一般的な開発コマンド

### 開発
```bash
npm run dev          # 開発サーバーを開始 (localhost:3000)
npm run build        # 本番用にビルド
npm run preview      # 本番ビルドをプレビュー
npm run test         # Vitestを使用してユニットテストを実行
npm run coverage     # カバレッジレポート付きでテストを実行
```

### Docker開発
```bash
docker-compose up -d # コンテナ化された開発環境を開始
```

## アーキテクチャ概要

### 技術スタック
- **フロントエンド**: Nuxt 3 + Vue 3 + TypeScript + TailwindCSS
- **マップ**: Leaflet.js with OpenStreetMap
- **バックエンド**: Supabase (PostgreSQL)
- **ジオコーディング**: OpenStreetMap Nominatim API
- **テスト**: Vitest + Vue Test Utils
- **コンテナ化**: Docker

### データベーススキーマ
コアエンティティは`snow_reports`テーブルです：
```sql
CREATE TABLE snow_reports (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  area VARCHAR NOT NULL,                    -- 場所・エリア名
  start_time TIMESTAMP WITH TIME ZONE NOT NULL,  -- 除雪開始時刻
  end_time TIMESTAMP WITH TIME ZONE NOT NULL,    -- 除雪終了時刻
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### APIエンドポイント
- `POST /api/snow/create` - 新しい除雪レポートを作成
- `POST /api/snow/update` - 既存レポートを更新
- `POST /api/snow/delete` - レポートを削除

### 主要なアプリケーションページ
- `/josetsu` - グループ化された除雪レポートを表示するメインページ
- `/snowlist` - CRUD操作用の管理インターフェース
- `/create` - 新しいレポートを作成するフォーム
- `/cache-test` - ジオコーディングキャッシュをテストする開発ページ

## アーキテクチャパターン

### 高度なキャッシングシステム
アプリは多層ジオコーディングキャッシュを実装しています：
- **localStorageの永続化** - セッション間での座標保持
- **グローバル状態管理** - Nuxtの`useState`を使用
- **リクエストの重複排除** - 冗長なAPI呼び出しを防止
- **パフォーマンス監視** - ヒット/ミス率の管理

### レート制限付きAPI統合
- **1秒間に1リクエスト** - Nominatim APIコンプライアンスの制限
- **指数バックオフ** - インテリジェントディレイ付きリトライロジック
- **リクエストキューイング** - 複数の同時リクエストを処理

### エラーハンドリング戦略
- **プログレッシブエンハンスメント** - グレースフルデグラデーション付き
- **一元化エラー管理** - `useErrorHandler`コンポーザブル経由
- **ユーザーフレンドリーメッセージ** - 開発用技術ログ付き

## 開発ガイドライン

### コードスタイル（Cursorルールより）
- `<script setup lang="ts">`で**Composition API**を使用
- デフォルトエクスポートより**名前付きエクスポート**を優先
- すべての関数に**明示的な戻り値の型**を使用
- `any`型を避け、代わりに`unknown`を使用
- Promiseチェーンより**async/await**を使用
- パブリックAPI関数には**TSDocコメント**を適用

### ファイル構成
- **コンポーネント**: PascalCase.vue（例：`SnowLocationMap.vue`）
- **コンポーザブル**: `use`プレフィックス付きcamelCase.ts（例：`useGeocodingCache.ts`）
- **型**: `server/types/`内の共有型
- **ユーティリティ**: `utils/`ディレクトリ内の純粋関数

### Supabase統合
- 直接`createClient`より`useSupabaseClient()`コンポーザブルを使用
- 可能な場合はサーバーAPI経由でデータにアクセス：`useFetch('/api/snow/reports')`
- 認証状態には`useSupabaseUser()`を使用

### コンポーネント構造順序
1. `<template>`
2. `<script setup lang="ts">`
3. `<style scoped>`

### 状態管理
- **ローカル状態**: `ref()`または`reactive()`
- **共有状態**: コンポーネント間データ用の`useState()`
- **エラー状態**: `useErrorHandler`経由で一元化

## 環境設定

### 必要な環境変数
```env
SUPABASE_URL="YOUR_SUPABASE_URL"
SUPABASE_KEY="YOUR_SUPABASE_ANON_KEY"
```

### 設定注意事項
- **SSR無効**: nuxt.config.tsで`ssr: false`、クライアントサイドレンダリング用
- **自動インポート**: コンポーネントとコンポーザブルは自動登録
- **TailwindCSS**: PostCSSパイプラインで設定

## 主要なコンポーザブル

### useGeocodingCache
- localStorageの永続化による座標キャッシュ管理
- キャッシュ統計と管理機能を提供
- グローバル状態同期を実装

### useGeocodingApi
- Nominatimへのレート制限付きAPIリクエストを処理
- リクエストの重複排除と指数バックオフを実装
- パフォーマンス監視とログ記録を提供

### useErrorHandler
- ユーザーフレンドリーメッセージ付き一元化エラーハンドリング
- 異なるエラータイプをサポート（FetchErrorなど）
- SSR互換エラー管理

## テスト

### ユニットテスト
- Vue Test Utils付きVitestフレームワークを使用
- テストファイル：`.test.ts`または`.spec.ts`サフィックス
- ソースファイルと並べてテストを配置
- 例：`utils/formatters.spec.ts`は`utils/formatters.ts`をテスト

### 開発時テスト
- `/cache-test`ページでキャッシュテストが利用可能
- ジオコーディングとマッピング機能の手動テスト

## 重要な注意事項

- アプリケーションは稚内市の除雪作業に特化
- すべてのUIテキストとエリア名は日本語
- Nominatim APIコンプライアンスにはレート制限が重要
- 開発時は認証が無効
- アプリはクライアントサイドレンダリングを使用（SSR無効）
- 機能改善や機能変更・機能追加を行った際にはこのファイルを必ず更新すること