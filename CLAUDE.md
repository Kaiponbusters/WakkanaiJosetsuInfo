# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is the "わっかない除雪情報マップ" (Wakkanai Snow Removal Information Map) - a real-time snow removal tracking web application for Wakkanai city, Hokkaido, Japan. The app displays snow clearing operations on an interactive map with administrative management capabilities.

## Common Development Commands

### Development
```bash
npm run dev          # Start development server (localhost:3000)
npm run build        # Build for production
npm run preview      # Preview production build
npm run test         # Run unit tests with Vitest
npm run coverage     # Run tests with coverage report
```

### Docker Development
```bash
docker-compose up -d # Start containerized development environment
```

## Architecture Overview

### Technology Stack
- **Frontend**: Nuxt 3 + Vue 3 + TypeScript + TailwindCSS
- **Maps**: Leaflet.js with OpenStreetMap
- **Backend**: Supabase (PostgreSQL)
- **Geocoding**: OpenStreetMap Nominatim API
- **Testing**: Vitest + Vue Test Utils
- **Containerization**: Docker

### Database Schema
The core entity is `snow_reports` table:
```sql
CREATE TABLE snow_reports (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  area VARCHAR NOT NULL,                    -- Location/area name
  start_time TIMESTAMP WITH TIME ZONE NOT NULL,  -- Snow removal start time  
  end_time TIMESTAMP WITH TIME ZONE NOT NULL,    -- Snow removal end time
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### API Endpoints
- `POST /api/snow/create` - Create new snow removal reports
- `POST /api/snow/update` - Update existing reports
- `POST /api/snow/delete` - Delete reports

### Key Application Pages
- `/josetsu` - Main page showing grouped snow removal reports
- `/snowlist` - Administrative interface for CRUD operations
- `/create` - Form for creating new reports
- `/cache-test` - Development page for testing geocoding cache

## Architecture Patterns

### Sophisticated Caching System
The app implements a multi-layered geocoding cache:
- **localStorage persistence** for coordinates across sessions
- **Global state management** using Nuxt's `useState`
- **Request deduplication** to prevent redundant API calls
- **Performance monitoring** with hit/miss ratios

### Rate-Limited API Integration
- **1 request per second** limit for Nominatim API compliance
- **Exponential backoff** retry logic with intelligent delays
- **Request queuing** to handle multiple simultaneous requests

### Error Handling Strategy
- **Progressive enhancement** with graceful degradation
- **Centralized error management** via `useErrorHandler` composable
- **User-friendly messages** with technical logging for development

## Development Guidelines

### Code Style (from Cursor rules)
- Use **Composition API** with `<script setup lang="ts">` 
- Prefer **named exports** over default exports
- Use **explicit return types** for all functions
- Avoid `any` type - use `unknown` instead
- Use **async/await** over Promise chains
- Apply **TSDoc comments** for public API functions

### File Organization
- **Components**: PascalCase.vue (e.g., `SnowLocationMap.vue`)
- **Composables**: camelCase.ts with `use` prefix (e.g., `useGeocodingCache.ts`)
- **Types**: Shared types in `server/types/`
- **Utils**: Pure functions in `utils/` directory

### Supabase Integration
- Use `useSupabaseClient()` composable instead of direct `createClient`
- Access data through server APIs when possible: `useFetch('/api/snow/reports')`
- Use `useSupabaseUser()` for authentication state

### Component Structure Order
1. `<template>`
2. `<script setup lang="ts">`
3. `<style scoped>`

### State Management
- **Local state**: `ref()` or `reactive()`
- **Shared state**: `useState()` for cross-component data
- **Error states**: Centralized via `useErrorHandler`

## Environment Setup

### Required Environment Variables
```env
SUPABASE_URL="YOUR_SUPABASE_URL"
SUPABASE_KEY="YOUR_SUPABASE_ANON_KEY"
```

### Configuration Notes
- **SSR disabled**: `ssr: false` in nuxt.config.ts for client-side rendering
- **Auto-imports**: Components and composables are auto-registered
- **TailwindCSS**: Configured with PostCSS pipeline

## Key Composables

### useGeocodingCache
- Manages coordinate caching with localStorage persistence
- Provides cache statistics and management functions
- Implements global state synchronization

### useGeocodingApi  
- Handles rate-limited API requests to Nominatim
- Implements request deduplication and exponential backoff
- Provides performance monitoring and logging

### useErrorHandler
- Centralized error handling with user-friendly messages
- Supports different error types (FetchError, etc.)
- SSR-compatible error management

## Testing

### Unit Tests
- Use Vitest framework with Vue Test Utils
- Test files: `.test.ts` or `.spec.ts` suffix
- Place tests alongside source files
- Example: `utils/formatters.spec.ts` tests `utils/formatters.ts`

### Development Testing
- Cache testing available at `/cache-test` page
- Manual testing of geocoding and mapping functionality

## Important Notes

- The application focuses specifically on Wakkanai city snow removal operations
- All UI text and area names are in Japanese
- Rate limiting is critical for Nominatim API compliance
- Authentication is currently disabled for development
- The app uses client-side rendering (SSR disabled)