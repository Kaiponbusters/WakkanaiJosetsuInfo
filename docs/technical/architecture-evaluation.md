# わっかない除雪情報マップ アーキテクチャ評価

## 概要
- 稚内市の除雪状況を可視化する Nuxt 3 ベースの SPA
- composable を中心としたビジネスロジック分離を実践
- Supabase、Leaflet、Nominatim 等の外部サービスに強く依存

## 長所
- **レイヤ構造が明確**: プレゼンテーション／アプリケーション／データアクセス／データ層が整理され、composable 単位で責務が分離
- **ロジックの再利用性が高い**: `useNotification*` や `useGeocoding*` など役割毎に整理された composable とテストが併置
- **ドキュメント・テストが充実**: UML、構造レポート、Playwright・Vitest など多層テスト基盤とドキュメントが整備
- **地図・通知機能への配慮**: レート制御・キャッシュなど運用安定性を意識した実装が存在
- **TDD 指向の文化**: t-wada 流 TDD を公式ルール化し、品質管理プロセスを明示

## 短所
- **Supabase へのロックイン**: 認証・データ・リアルタイムを Supabase に集約しており、障害時の代替や移行が難しい
- **サーバー API 層が薄い**: `server/api` が単純プロキシ化しており、ドメインルールやバリデーションがクライアント側に偏重
- **通知周りの責務が曖昧**: composable が多岐に分かれる一方で依存が絡み合い、実装/テストの維持コストが高い
- **クライアントサイド依存**: SSR 無効化により初回表示・SEO・アクセシビリティ面で行政情報サイトとしての要件を満たしにくい
- **リアルタイム要件の整理不足**: Supabase Realtime／通知統合の設計が未完成で、イベント伝搬や整合性が不明瞭
- **テスト維持コストの高騰リスク**: Playwright 等の E2E テストが肥大化しており、CI やモック戦略が未整備

## リスク・懸念点
- Supabase 障害・料金変更への脆弱性
- クライアント主体バリデーションによる不正リクエスト耐性の低さ
- composable 間依存の複雑化によるスパゲッティ化
- 行政サービスとして求められる可用性・信頼性要件に対する監視・冗長化設計の不足

## 推奨アクション
1. **BFF の強化**: `server/api` にドメインルール・バリデーション・エラーハンドリングを集約し、クライアントとの責務分担を再定義
2. **Supabase 依存の緩和**: 抽象化レイヤを導入し、データ／認証サービスの差し替え余地を確保
3. **通知・リアルタイム設計の再整理**: イベントフロー、失敗時フォールバック、状態同期の責務を composable と API で明確化
4. **SSR／SEO 対応の再検討**: 重要ページに SSR もしくは静的生成を導入し、パフォーマンスとアクセシビリティを改善
5. **テスト戦略の再構築**: Playwright を中心にモック・フィクスチャ管理、CI 実行時間を見直し、リファクタリング阻害要因を削減
6. **運用体制の整備**: ログ収集、アラート、リリース手順を確立し、行政サービスとしての信頼性を確保
