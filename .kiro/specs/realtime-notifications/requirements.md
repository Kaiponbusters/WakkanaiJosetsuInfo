# 要件定義書

## 概要

この機能は、稚内市除雪情報システムのリアルタイム通知システムを実装します。ユーザーは特定の地域の通知を購読し、関心のある地域で除雪作業が開始または終了した際に即座にアラートを受け取ることができます。これにより、住民や来訪者はアプリケーションを常時確認することなく、現在の除雪活動について情報を得ることができます。

## 要件

### 要件1

**ユーザーストーリー:** 稚内市の住民として、自分の地域の通知を購読したい。そうすることで、自分の地域で除雪作業が開始または終了した際に即座に通知を受け取ることができる。

#### 受入基準

1. ユーザーが通知設定ページを訪問した時、システムは購読可能な地域のリストを表示する
2. ユーザーが関心のある地域を選択した時、システムはその設定をローカルストレージに保存する
3. 購読した地域で除雪作業が開始された時、システムはユーザーにリアルタイム通知を送信する
4. 購読した地域で除雪作業が終了した時、システムはユーザーにリアルタイム通知を送信する
5. ユーザーのブラウザがプッシュ通知をサポートしている場合、システムは許可を要求してブラウザ通知を使用する
6. ユーザーのブラウザがプッシュ通知をサポートしていない場合、システムはアプリ内通知を使用する

### 要件2

**ユーザーストーリー:** アプリケーションのユーザーとして、通知設定を管理したい。そうすることで、どの地域の通知を受け取るか、どのように受け取るかを制御できる。

#### 受入基準

1. ユーザーが通知設定にアクセスした時、システムは現在の購読状況を表示する
2. ユーザーが新しい地域の購読を追加したい時、システムは利用可能な地域の検索インターフェースを提供する
3. ユーザーが地域の購読を削除したい時、システムは簡単に購読解除できる方法を提供する
4. ユーザーが通知設定を変更した時、システムは即座に変更を保存する
5. ユーザーがすべての通知を無効にした時、システムはそのユーザーへの通知送信を停止する

### 要件3

**ユーザーストーリー:** ユーザーとして、リアルタイムで通知を受け取りたい。そうすることで、遅延なく除雪作業に関するタイムリーな情報を得ることができる。

#### 受入基準

1. 新しい除雪報告が作成された時、システムは即座にその地域を購読しているユーザーを確認する
2. 購読ユーザーが見つかった時、システムは5秒以内に通知を送信する
3. ユーザーがアプリケーションをアクティブに使用している時、通知はアプリ内トーストメッセージとして表示される
4. ユーザーがアプリケーションをアクティブに使用していない時、通知はブラウザプッシュ通知として表示される
5. 通知配信が失敗した場合、システムは指数バックオフで最大3回再試行する

### 要件4

**ユーザーストーリー:** ユーザーとして、受信した通知の履歴を確認したい。そうすることで、購読した地域の過去の除雪活動を確認できる。

#### 受入基準

1. ユーザーが通知を受信した時、システムは通知履歴に保存する
2. ユーザーが通知履歴ページにアクセスした時、システムは日付でグループ化された通知を表示する
3. ユーザーが通知履歴を確認する時、システムは地域、作業種別（開始/終了）、タイムスタンプを表示する
4. 通知履歴が50件を超えた時、システムは自動的に最も古い通知を削除する
5. ユーザーが通知履歴をクリアしたい時、システムはすべてクリアするオプションを提供する

### 要件5

**ユーザーストーリー:** 管理者として、通知システムが確実に動作することを望む。そうすることで、ユーザーが除雪作業に関する正確でタイムリーな情報を受け取ることができる。

#### 受入基準

1. システムがsnow_reportsテーブルの変更を検出した時、通知プロセスをトリガーする
2. 複数のユーザーが同じ地域を購読している時、システムは効率的に通知をバッチ処理して送信する
3. 通知サービスが利用できない時、システムは後で配信するために通知をキューに入れる
4. システムリソースが限られている時、通知システムはアクティブユーザーを優先する
5. 通知配信が繰り返し失敗した場合、システムは監視とデバッグのためにエラーをログに記録する