# 要件書

## はじめに

稚内除排雪システムのユーザーワークフローを包括的にテストするための自動化テストシステムを構築します。このシステムは、フロントエンド、バックエンドAPI、データベース、PWA機能を含む全システムコンポーネントを網羅し、Playwright MCPを活用してブラウザベースのE2Eテストを実行します。

## 要件

### 要件1

**ユーザーストーリー:** 一般ユーザーとして、除雪情報を閲覧できることを確認したい

#### 受け入れ基準

1. WHEN ユーザーが除雪情報表示ページ（/josetsu）にアクセスした時 THEN システムは除雪情報を日付別にグループ化して表示する
2. WHEN ユーザーが日付グループをクリックした時 THEN システムはその日の除雪情報の詳細を展開表示する
3. WHEN 除雪情報が存在しない時 THEN システムは適切なメッセージを表示する
4. WHEN ページが読み込まれた時 THEN システムはローディング状態を適切に表示する
5. WHEN 地図コンポーネントが表示された時 THEN システムは地域の位置情報を正確に表示する
6. WHEN データベースから除雪情報を取得した時 THEN システムは最新の情報を降順で表示する

### 要件2

**ユーザーストーリー:** 管理者として、除雪情報を登録できることを確認したい

#### 受け入れ基準

1. WHEN 管理者が登録ページ（/create）にアクセスした時 THEN システムは除雪情報登録フォームを表示する
2. WHEN 管理者が必要な情報を入力してフォームを送信した時 THEN システムは除雪情報を正常に登録する
3. WHEN 管理者が必須項目を未入力でフォームを送信した時 THEN システムは適切なバリデーションエラーを表示する
4. WHEN 管理者が終了時間を開始時間より前に設定した時 THEN システムは時間範囲エラーを表示する
5. WHEN 登録が成功した時 THEN システムは成功メッセージを表示し、適切なページに遷移する
6. WHEN APIエンドポイント（/api/snow/create）が呼び出された時 THEN システムはデータベースに正確にデータを保存する
7. WHEN フォーム送信中の時 THEN システムは送信ボタンを無効化し、ローディング状態を表示する

### 要件3

**ユーザーストーリー:** 管理者として、除雪情報を管理できることを確認したい

#### 受け入れ基準

1. WHEN 管理者が管理ページ（/snowlist）にアクセスした時 THEN システムは登録済みの除雪情報一覧を表示する
2. WHEN 管理者が「新規登録」ボタンをクリックした時 THEN システムは登録ページ（/create）に遷移する
3. WHEN 管理者が編集ボタンをクリックした時 THEN システムは編集モーダルを表示し、既存データを入力フィールドに設定する
4. WHEN 管理者が除雪情報を編集して更新した時 THEN システムは変更を正常に保存し、一覧に反映する
5. WHEN 管理者が削除ボタンをクリックした時 THEN システムは確認ダイアログを表示する
6. WHEN 管理者が削除を確認した時 THEN システムは除雪情報を削除し、一覧から除外する
7. WHEN 更新APIエンドポイント（/api/snow/update）が呼び出された時 THEN システムはデータベースの該当レコードを正確に更新する
8. WHEN 削除APIエンドポイント（/api/snow/delete）が呼び出された時 THEN システムはデータベースから該当レコードを削除する
9. WHEN 存在しないIDで更新・削除を試行した時 THEN システムは適切な404エラーを返す

### 要件4

**ユーザーストーリー:** システム管理者として、PWA通知機能の基本動作を確認したい

#### 受け入れ基準

1. WHEN ユーザーが通知設定ページにアクセスした時 THEN システムはサービスワーカーの登録状況を表示する
2. WHEN ユーザーが通知許可をリクエストした時 THEN システムはブラウザの通知許可ダイアログを表示する
3. WHEN サービスワーカーが正常に登録された時 THEN システムは登録状況を適切に表示する
4. WHEN モバイルビューポートでテストが実行された時 THEN システムはレスポンシブデザインが正常に機能する

### 要件5

**ユーザーストーリー:** 開発者として、テスト結果を分析できることを確認したい

#### 受け入れ基準

1. WHEN テストが実行された時 THEN システムは詳細なテスト結果レポートを生成する
2. WHEN テストが失敗した時 THEN システムはスクリーンショットとエラー詳細を記録する
3. WHEN テストが完了した時 THEN システムは実行時間とカバレッジ情報を提供する
4. WHEN テストが継続的に実行された時 THEN システムは履歴データを保持し、傾向分析を可能にする

### 要件6

**ユーザーストーリー:** 一般ユーザーとして、自分が登録した場所の除雪情報について通知を受け取りたい

#### 受け入れ基準

1. WHEN ユーザーが通知設定ページ（/notifications）にアクセスした時 THEN システムは通知設定画面を表示する
2. WHEN ユーザーが特定の地域の通知を有効にした時 THEN システムは通知設定を保存する
3. WHEN 登録した地域で除雪作業が開始される時 THEN システムはリアルタイム通知を送信する
4. WHEN ユーザーが通知履歴を確認した時 THEN システムは過去の通知履歴を表示する
5. WHEN 通知が送信された時 THEN システムは通知の配信状況を記録する

### 要件7

**ユーザーストーリー:** 品質保証担当者として、APIエンドポイントの動作を確認したい

#### 受け入れ基準

1. WHEN 各APIエンドポイント（create/update/delete）が呼び出された時 THEN システムは適切なHTTPステータスコードを返す
2. WHEN 不正なデータでAPIを呼び出した時 THEN システムは400 Bad Requestエラーを返す
3. WHEN 存在しないリソースにアクセスした時 THEN システムは404 Not Foundエラーを返す
4. WHEN サーバーエラーが発生した時 THEN システムは500 Internal Server Errorを返し、エラー詳細をログに記録する
5. WHEN APIレスポンスが返された時 THEN システムは一貫したJSON形式（success/data/error）で応答する

### 要件8

**ユーザーストーリー:** 品質保証担当者として、データの整合性を確認したい

#### 受け入れ基準

1. WHEN 除雪情報が登録された時 THEN システムはデータベースに正確に保存され、created_atタイムスタンプが自動設定される
2. WHEN 除雪情報が更新された時 THEN システムは指定されたフィールドのみを更新し、他のデータは保持する
3. WHEN 除雪情報が削除された時 THEN システムはデータベースから該当レコードを完全に削除する
4. WHEN 複数のユーザーが同時に操作した時 THEN システムはデータの競合状態を適切に処理する
5. WHEN データベース接続エラーが発生した時 THEN システムは適切なエラーハンドリングを行う

### 要件9

**ユーザーストーリー:** システム管理者として、エンドツーエンドのワークフローを確認したい

#### 受け入れ基準

1. WHEN 管理者が除雪情報を登録した時 THEN システムは登録から表示まで一連の流れが正常に動作する
2. WHEN 一般ユーザーが情報を閲覧した時 THEN システムは最新の登録情報が即座に反映される
3. WHEN 管理者が情報を更新した時 THEN システムは変更が全ての表示ページに反映される
4. WHEN 管理者が情報を削除した時 THEN システムは削除された情報が全ての表示から除外される
5. WHEN システム全体のワークフローが実行された時 THEN システムは各ステップでデータの一貫性を保つ